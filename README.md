# scooter_charge_display

Небольшое приложение на ESP-IDF, показывающее уровень заряда аккумулятора электросамоката на круговом индикаторе (LVGL) и текущем напряжении. Данные берутся с датчика INA2xx по I2C. Отрисовка ведется на круглому дисплее GC9A01 (SPI). Дополнительно выводятся часы (системное время).

## Возможности
- Круговой индикатор заряда 0–100% с цветовой индикацией
  - 0–33% — красный, 34–66% — оранжевый, 67–90% — янтарный, >90% — зеленый
- Отображение напряжения в Вольтах (округление до 0.1 В)
- Текущие часы внизу экрана
- Плавная интеграция LVGL 9 с двубуферной отрисовкой
- Работа с INA-сенсором по I2C (адрес 0x40)

## Архитектура и компоненты
- `main/main.c` — UI на LVGL, периодическая выборка напряжения, расчет процента, задачи FreeRTOS
- `components/lvgl_port_disp` — портирование LVGL: инициализация, буферы, задачи `tick_task`/`handler_task`, `disp_flush`
- `components/gc9a01` — драйвер дисплея GC9A01 (SPI) + Kconfig для пинов/частоты
- `components/twi` — инициализация I2C master-bus (ESP-IDF v5 API)
- `components/ina` — работа с INA2xx: чтение напряжения из регистра 0x02, масштабирование
- `components/fonts` — шрифты (например, `lv_font_montserrat_70_num`)
- `managed_components/lvgl__lvgl` — LVGL 9.3.0 через IDF Component Manager

## Требования
- ESP-IDF: 5.5.0 (см. `dependencies.lock`) — код использует новый I2C master-bus API (v5+)
- Целевая платформа по умолчанию: `esp32c3` (см. `dependencies.lock`)
- Дисплей GC9A01 (240x240)
- Датчик тока/напряжения INA2xx (адрес по умолчанию 0x40)

## Аппаратные подключения (по умолчанию из sdkconfig/кода)
- SPI (GC9A01)
  - SCK: GPIO5 (`CONFIG_GC9A01_PIN_NUM_SCK`)
  - MOSI: GPIO6 (`CONFIG_GC9A01_PIN_NUM_MOSI`)
  - CS: GPIO8 (`CONFIG_GC9A01_PIN_NUM_CS`)
  - DC: GPIO7 (`CONFIG_GC9A01_PIN_NUM_DC`)
  - RST: GPIO9 (`CONFIG_GC9A01_PIN_NUM_RST`, включен)
  - Подсветка: GPIO0 (`CONFIG_GC9A01_PIN_NUM_BCKL`, режим PWM)
  - Частота SPI: 80 МГц (`CONFIG_GC9A01_SPI_SCK_FREQ_M`)
- I2C (INA)
  - Порт: `I2C_NUM_0`
  - SDA: GPIO20
  - SCL: GPIO10
  - Внутренние подтяжки включены

Пины SPI настраиваются через `menuconfig` в разделе GC9A01; пины I2C заданы в `components/twi/twi.c` и при необходимости правятся в коде проекта.

## Логика расчета процентов
В `main/main.c` определены константы:
- `AKK_MIN = 50.0` — минимальное напряжение батареи (В)
- `AKK_MAX = 66.8` — максимальное напряжение батареи (В)
- `DIVISOR_COEFF = 2.0` — коэффициент делителя напряжения перед ADC/INA

Текущий процент вычисляется по формуле линейной интерполяции и ограничивается диапазоном 0–100%. Для подстройки под вашу батарею/схему измените эти значения и пересоберите проект.

## Сборка и прошивка
1) Подготовьте ESP-IDF 5.5.0 (или совместимую 5.x)
2) Установите целевую платформу и проверьте зависимости:
   ```bash
   idf.py set-target esp32c3
   idf.py reconfigure
   ```
3) При необходимости скорректируйте параметры дисплея:
   ```bash
   idf.py menuconfig
   # Component config → GC9A01 LCD Config
   ```
4) Сборка, прошивка и монитор:
   ```bash
   idf.py build flash monitor
   ```

## Как это работает
- `lv_port_disp_init()` настраивает LVGL, буферы, и запускает две задачи:
  - `tick_task` — инкремент тиков LVGL (каждую 1 мс)
  - `handler_task` — обработчик LVGL таймеров/рендера
- `main_task` периодически считывает напряжение `ina_get_voltage()` (через I2C), применяет `DIVISOR_COEFF`, переводит напряжение в проценты, обновляет дугу и метки LVGL
- `time_task` раз в секунду обновляет метку с текущим временем

## Полезные файлы
- `sdkconfig` — значения пинов и настроек дисплея (автогенерируется/редактируется через menuconfig)
- `dependencies.lock` — зафиксированные версии IDF (5.5.0), LVGL (9.3.0), целевой чип (`esp32c3`)

## Настройка под свою плату
- Если пинов SPI по умолчанию нет на вашей плате — измените их в `menuconfig` (GC9A01)
- Если пинов I2C по умолчанию нет — поправьте `components/twi/twi.c`
- Адрес INA регулируется в `components/ina/ina.c` (`.device_address = 0x40`)
- При другой батарее и делителе напряжения обновите `AKK_MIN/AKK_MAX/DIVISOR_COEFF` в `main/main.c`

## Структура проекта
- `main/` — точка входа приложения, UI, логика
- `components/`
  - `gc9a01/` — SPI-драйвер дисплея + `Kconfig`
  - `lvgl_port_disp/` — порт LVGL и дисплейный бэкенд
  - `twi/` — инициализация I2C master-bus
  - `ina/` — работа с INA2xx
  - `fonts/` — встроенные шрифты для LVGL
- `managed_components/lvgl__lvgl/` — зависимость LVGL 9.3.0

## Примечания
- Время берется из системного таймера; RTC/синхронизация не настраиваются.
- Цветовая схема и пороги назначаются в `main/main.c`.
- Производительность SPI зависит от разводки и качества кабеля; при артефактах снизьте `CONFIG_GC9A01_SPI_SCK_FREQ_M`.

